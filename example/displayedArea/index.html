<!DOCTYPE HTML>
<html>
<head>
    <!-- twitter bootstrap CSS stylesheet - included to make things pretty, not needed or used by cornerstone -->
    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">

        <h1>
            displaedArea/index.html
        </h1>

        This example demonstrates the IHE Image Display Test 521: Consistent Presentation of Images.
        <br>
        <br>
        <span>Select a test:</span>
        <select id="testCasesSelect">
            <option value="example://DISA_P01">DISA_P01</option>
            <option value="example://DISA_P02">DISA_P02</option>


        </select>

        <div id="displayArea" style="width:512px;">
            <h3>Display Area:</h3>
            <span>top/left hand corner:</span>
            <div class="input-group">
                <input id="area-top" class="form-control" type="text" placeholder="top" />
                <span class="input-group-addon">/</span>
                <input id="area-left" class="form-control" type="text" placeholder="left" />
            </div>
            <span>bottom/right hand corner:</span>
            <div class="input-group">
                <input id="area-bottom" class="form-control" type="text" placeholder="bottom" />
                <span class="input-group-addon">/</span>
                <input id="area-right" class="form-control" type="text" placeholder="right" />
            </div>
            <input id="presentationMode" type="text" value="SCALE TO FIT" disabled="disabled" />
            <input id="area-apply" type="button" value="Apply Area" />
        </div>
        <div><h3 id="testResult"></h3></div>
        <br>
        <div>
            <span>Viewer Size:</span><span id="viewerSize"></span><span> | </span>
            <span>Image Size:</span><span id="imageSize"></span>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-sm-6" style="padding-right:10px">
                    <h4>Displayed Image area</h4>
                    <div id="dicomImage" style="height:512px"
                         oncontextmenu="return false"
                         onmousedown="return false"></div>
                </div> 

                <div class="col-sm-6">
                    <h4>Referenced image loaded 'Fit To Window':</h4>
                    <div id="origDicomImage" style="height:512px"
                         oncontextmenu="return false"
                         onmousedown="return false"></div>
                </div>

            </div>
        </div>

    </div>
</body>

<!-- include the cornerstone library -->
<script src="../../dist/cornerstone.js"></script>
<script>window.cornerstone || document.write('<script src="https://unpkg.com/cornerstone-core">\x3C/script>')</script>

<!-- include special code for these examples which provides images -->
<script src="../exampleImageIdLoaderRaw.js"></script>

<script>
    const viewportOptions = {
        scale: 1.0,
        translation: {
            x: 0,
            y: 0
        },
        invert: false,
        pixelReplication: false
    };
    const element = document.getElementById('dicomImage');
    const origElement = document.getElementById('origDicomImage');
    
    cornerstone.enable(element);
    cornerstone.enable(origElement);

    loadSelectedCase();
    
    document.getElementById('testCasesSelect').addEventListener('change', () => {
        loadSelectedCase();
    });


    document.getElementById('area-apply').addEventListener("click", function () {
        let viewport = cornerstone.getViewport(element);

        viewport.displayedArea.tlhc.x = document.getElementById('area-left').value;
        viewport.displayedArea.tlhc.y = document.getElementById('area-top').value;
        viewport.displayedArea.brhc.x = document.getElementById('area-right').value;
        viewport.displayedArea.brhc.y = document.getElementById('area-bottom').value;
        document.getElementById('testResult').textContent = "";

        cornerstone.setViewport(element, viewport);
    });

    function loadSelectedCase() {
        let imageId = document.getElementById('testCasesSelect').value;

        cornerstone.loadImage(imageId).then(function (image) {
            let dicomImageElement = document.getElementById('dicomImage');
            
            cornerstone.displayImage(element, image, viewportOptions);
            cornerstone.displayImage(origElement, image, viewportOptions);

            cornerstone.fitToWindow(origElement);
            applyTestViewport(element,image);
        });
    }

    function applyTestViewport(element, image) {
        if (image.testCase) {
            let viewport = cornerstone.getViewport(element);

            viewport.displayedArea = image.testCase.displayedArea;

            cornerstone.setViewport(element, viewport);

            updateUI(element, image, viewport, image.testCase.result);
        }
    }

    function updateUI(element, image, viewport, result) {
        
        if (result) {
            document.getElementById('testResult').textContent = result.description;
        }

        document.getElementById('area-left').value = viewport.displayedArea.tlhc.x;
        document.getElementById('area-top').value = viewport.displayedArea.tlhc.y;
        document.getElementById('area-right').value = viewport.displayedArea.brhc.x;
        document.getElementById('area-bottom').value = viewport.displayedArea.brhc.y;

        document.getElementById('viewerSize').textContent = element.clientWidth + 'px X ' + element.clientHeight + 'px';
        document.getElementById('imageSize').textContent = image.width + 'px X ' + image.height + 'px';
    }
</script>
</html>
